<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đổi mật khẩu</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .change-pass-container {
            max-width: 420px;
            margin: 60px auto;
            background: #fff;
            border-radius: 14px;
            border: 1px solid #e0e0e0;
            padding: 32px;
            font-size: 17px;
            box-shadow: 0 2px 16px rgba(37,99,235,0.08);
            color: #1746a0;
        }
        .change-pass-container h2 {
            text-align: center;
            color: #2563eb;
            margin-bottom: 24px;
        }
        .change-pass-container form {
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: none;
            box-shadow: none;
            padding: 0;
        }
        .change-pass-container input {
            font-size: 1rem;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1.5px solid #bfc9da;
            outline: none;
            transition: border 0.15s, box-shadow 0.15s;
        }
        .change-pass-container input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px #e0e7ff;
        }
        .change-pass-container button {
            margin-top: 10px;
            background: linear-gradient(90deg, #2563eb 60%, #60a5fa 100%);
            color: #fff;
            border: none;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            border-radius: 8px;
            padding: 12px 0;
            font-size: 1.08em;
            box-shadow: 0 2px 8px rgba(37,99,235,0.07);
            transition: background 0.15s, box-shadow 0.15s;
        }
        .change-pass-container button:hover {
            background: linear-gradient(90deg, #1746a0 60%, #2563eb 100%);
            box-shadow: 0 4px 16px rgba(37,99,235,0.13);
        }
        .change-pass-container .back-link {
            display: block;
            margin-top: 18px;
            text-align: center;
            color: #2563eb;
            text-decoration: underline;
            font-size: 1em;
        }
        #changePassError {
            color: #e53935;
            text-align: center;
            margin-top: 10px;
            min-height: 22px;
        }
        @media (max-width: 600px) {
            .change-pass-container { max-width: 98vw; padding: 18px 4vw; }
        }
    </style>
</head>
<body>
    <div class="change-pass-container">
        <h2><i class="fa-solid fa-key"></i> Đổi mật khẩu</h2>
        <form id="changePassForm" autocomplete="off">
            <input type="password" id="oldPassword" placeholder="Mật khẩu cũ" required autocomplete="current-password">
            <input type="password" id="newPassword" placeholder="Mật khẩu mới" required autocomplete="new-password">
            <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới" required autocomplete="new-password">
            <button type="submit"><i class="fa-solid fa-unlock-keyhole"></i> Đổi mật khẩu</button>
        </form>
        <div id="changePassError"></div>
        <a href="profile.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> Quay lại hồ sơ</a>
    </div>
    <script src="script/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Lấy userId từ localStorage hoặc query param (?uid=)
        let user = null;
        try { user = JSON.parse(localStorage.getItem('user')); } catch {}
        let userId = user && user.MaNguoiDung ? user.MaNguoiDung : null;
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('uid')) userId = urlParams.get('uid');

        const form = document.getElementById('changePassForm');
        const errorDiv = document.getElementById('changePassError');
        form.onsubmit = async function(e) {
            e.preventDefault();
            errorDiv.innerText = '';
            const oldPass = document.getElementById('oldPassword').value.trim();
            const newPass = document.getElementById('newPassword').value.trim();
            const confirmPass = document.getElementById('confirmPassword').value.trim();
            if (!userId) {
                errorDiv.innerText = 'Không xác định được tài khoản! Vui lòng đăng nhập lại trước khi đổi mật khẩu.';
                return;
            }
            if (!oldPass || !newPass || !confirmPass) {
                errorDiv.innerText = 'Vui lòng nhập đầy đủ thông tin!';
                return;
            }
            if (newPass !== confirmPass) {
                errorDiv.innerText = 'Mật khẩu mới không khớp!';
                return;
            }
            if (newPass.length < 6) {
                errorDiv.innerText = 'Mật khẩu mới phải từ 6 ký tự!';
                return;
            }
            if (oldPass === newPass) {
                errorDiv.innerText = 'Mật khẩu mới phải khác mật khẩu cũ!';
                return;
            }
            try {
                const res = await fetch('http://localhost:3000/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaNguoiDung: userId, oldPassword: oldPass, newPassword: newPass })
                });
                if (res.ok) {
                    showToast('Đổi mật khẩu thành công!');
                    setTimeout(() => { window.location.href = 'profile.html'; }, 1200);
                } else {
                    let msg = 'Đổi mật khẩu thất bại!';
                    try {
                        const data = await res.json();
                        if (data && data.message) msg = data.message;
                    } catch {}
                    errorDiv.innerText = msg;
                }
            } catch (err) {
                errorDiv.innerText = 'Không thể kết nối máy chủ. Vui lòng thử lại!';
            }
        };
    });
    </script>
</body>
</html>
